<!--
 * Copyright (C) 2016 Ericsson AB. All rights reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 -->

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>MultiClientConferenceCall</title>
  <link rel="stylesheet" type="text/css" href="../resources/main.css">
  <link rel="icon" href="../resources/favicon.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/3.2.1/es6-promise.min.js"></script>
  <script type="text/javascript" src="https://get.cct.ericsson.net/latest/cct.js"></script>
  <script type="text/javascript" src="../exampleUtils.js"></script>
  <style>
    .remoteVideo {
      max-width: 16vw;
      max-height: 9vw;
      margin-top: 1vw;
      border: solid white 1px;
    }
  </style>
</head>
<body>
  <header></header>
  <main>
    <section>
      <div class="peer-link">
        <h3 class="peer-link-title"></h3>
        <input class="peer-link-input" type="url" value="" size="55">
      </div>
    </section>
    <div class="margins centered column">
      <div class="video-container">
        <video id="bigVideo" muted autoplay></video>
      </div>
      <div id="thumbnailContainer" class="row"></div>
      <div id="controlsContainer" class="row">
        <button class="margins" type="button" id="audioButton">Microphone: On</button>
        <button class="margins" type="button"  id="videoButton">Camera: On</button>
      </div>
    </div>
    <footer></footer>
  </main>
  <script type="text/javascript">
'use strict'

cct.log.setLogLevel('example', cct.log.ALL)

var bigVideo = document.getElementById('bigVideo')
var thumbnailContainer = document.getElementById('thumbnailContainer')
var microphone
var hdCamera
// var audioMeters = {}
var client
var room
var videoBroadcaster
var audioBroadcaster
var thumbnailBroadcaster
var conference

cct.webRtcReady()
  .then(setupMediaSources)
  .then(setupConference)
  .then(setupSwitcher)
  .then(setupThumbnailBroadcaster)
  .then(setupAudioBroadcaster)
  .then(setupButtonListeners)
  .catch(function (err) {
    cct.log.error('example', 'Failed to setup conference, ' + err)
  })

function setupMediaSources() {
  cct.log.info('example', 'setting up media sources')
  hdCamera = new cct.DeviceSource({
    video: {
      width: {ideal: 640},
      height: {ideal: 360},
    },
  })

  microphone = new cct.DeviceSource({
    audio: true,
  })

  return Promise.all([hdCamera.promise, microphone.promise])
}

function setupConference() {
  cct.log.info('example', 'setting up client' + ' using: ' + EXAMPLE_UTILS_ICE_SERVERS)
  client = new cct.Client({
    iceServers: EXAMPLE_UTILS_ICE_SERVERS,
  })
  return PeerConnecter.clientInRoom(client).then(function (connecter) {
    cct.log.info('example', 'setting up conference')
    room = connecter.room
    conference = room.startConference({switcherMode: 'automatic'})
    return Promise.resolve(conference)
  })
}

function setupSwitcher(conference) {
  cct.log.info('example', 'setting up switcher')
  hdCamera.connect(conference.switcher)
  conference.switcher.connect(bigVideo)
  conference.switcher.on('speaker', function (newActive) {
    cct.log.info('example', 'switched to ' + newActive)
  })
  return conference
}

function setupThumbnailBroadcaster(conference) {
  cct.log.info('example', 'setting up thumbnail broadcaster')

  thumbnailBroadcaster = new cct.ThumbnailBroadcaster({
    projectionConfiguration: {
      width: 100,
      aspectRatio: 16/9,
      contentMode: 'aspectFill',
    },
    videoFrameRate: 10,
    imageFrameRate: 1/5,
  })

  cct.log.info('example', 'connecting hdCamera to thumbnailBroadcaster')
  hdCamera.connect(thumbnailBroadcaster)

  cct.log.info('example', 'setting up events for sinkRenderer')
  let renderer = thumbnailBroadcaster.createRenderer({elementClass: 'c3-example-thumbnail'})

  renderer.on('added', function(elements) {
    addElements(elements)
  })

  renderer.on('removed', function(elements) {
    removeElements(elements)
  })

  conference.attach('thumbnailbroadcaster', thumbnailBroadcaster)
  return conference
}

function setupAudioBroadcaster(conference) {
  cct.log.info('example', 'setting up audio broadcast')
  audioBroadcaster = new cct.MediaBroadcaster()
  microphone.connect(audioBroadcaster)
  conference.attach('audioBroadcast', audioBroadcaster)

  audioBroadcaster.on('remoteSource', function (event) {
    var peer = event.peer
    var source = event.source
    if (event.source) {
      addRemoteAudioElement(peer, source)
    } else {
      removeRemoteAudioElement(peer)
    }
  })

  return conference
}

function setupButtonListeners() {
  cct.log.info('example', 'setting up button listeners')
  var audioButton = document.getElementById('audioButton')
  var videoButton = document.getElementById('videoButton')

  audioButton.onclick = function () {
    microphone.mute.audio = !microphone.mute.audio
    audioButton.innerText = microphone.mute.audio ? 'Microphone: Off' : 'Microphone: On'
  }
  videoButton.onclick = function () {
    hdCamera.mute.video = !hdCamera.mute.video
    sdCamera.mute.video = !sdCamera.mute.video
    videoButton.innerText = hdCamera.mute.video ? 'Camera: Off' : 'Camera: On'
  }
}

function addElements(elements) {
  cct.log.info('example', `adding elements: ${JSON.stringify(elements)}`)
  for (var i = 0; i < elements.length; i++) {
    thumbnailContainer.appendChild(elements[i])
  }
}

function removeElements(elements) {
  cct.log.info('example', `removing elements: ${JSON.stringify(elements)}`)
  for (var i = 0; i < elements.length; i++) {
    thumbnailContainer.removeChild(elements[i])
  }
}

function addRemoteAudioElement(peer, source) {
  var audioId = 'audio:' + peer
  var audioEl = document.getElementById(audioId)
  if (!audioEl) {
    audioEl = document.createElement('audio')
    audioEl.id = audioId
    audioEl.autoplay = true
    document.body.appendChild(audioEl)
  }
  source.connect(audioEl)
}

function removeRemoteAudioElement(peer) {
  var audioEl = document.getElementById('audio:' + peer)
  document.body.removeChild(audioEl)
}
  </script>
</body>
</html>
